@model Etic.Entities.Category

@{
    ViewData["Title"] = "Create Category";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a asp-action=\"Index\">Categories</a></li><li class=\"breadcrumb-item active\">Create New</li>";
}

<!-- Form Container -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <form asp-area="Admin" asp-action="Create" method="post" id="categoryForm">
            
            <!-- Main Card -->
            <div class="data-table mb-4">
                <div class="table-header">
                    <h6 class="mb-0" style="font-weight: 600;">
                        <i class="fas fa-folder-plus me-2" style="color: var(--primary);"></i>Category Information
                    </h6>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <label asp-for="Name" class="form-label" style="font-weight: 500; color: var(--dark);">
                            Category Name <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Name" class="form-control form-control-lg" 
                               placeholder="e.g. Electronics" 
                               id="categoryName"
                               style="border-radius: 8px; border: 1px solid var(--gray-300); padding: 12px 16px;" />
                        <span asp-validation-for="Name" class="text-danger small"></span>
                    </div>

<div class="mb-4">
                        <label asp-for="SeoLink" class="form-label" style="font-weight: 500; color: var(--dark);">
                            SEO URL Slug <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input asp-for="SeoLink" class="form-control form-control-lg" 
                                   placeholder="e.g. electronics" 
                                   id="seoLinkInput"
                                   style="border-radius: 8px 0 0 8px; border: 1px solid var(--gray-300); padding: 12px 16px;" />
                            <button type="button" class="btn btn-outline-primary" id="generateSlug" 
                                    style="border-radius: 0 8px 8px 0; border-left: none;">
                                <i class="fas fa-magic me-1"></i>Auto Generate
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>Use lowercase letters, numbers and dashes only
                            </small>
                            <small id="slugStatus" class="text-muted"></small>
                        </div>
                        <span asp-validation-for="SeoLink" class="text-danger small"></span>
</div>

                    <!-- SEO Preview -->
                    <div style="background: var(--light-gray); padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-link me-3 mt-1" style="color: var(--primary);"></i>
                            <div style="flex: 1;">
                                <small class="text-muted d-block mb-1">URL Preview:</small>
                                <code id="urlPreview" style="font-size: 13px; color: var(--primary);">yoursite.com/category/</code>
                            </div>
                        </div>
                    </div>
    </div>
            </div>

            <!-- Icon Card -->
            <div class="data-table mb-4">
                <div class="table-header">
                    <h6 class="mb-0" style="font-weight: 600;">
                        <i class="fas fa-icons me-2" style="color: var(--info);"></i>Category Icon (Optional)
                    </h6>
                </div>
                <div class="p-4">
            <div class="mb-3">
                        <label class="form-label" style="font-weight: 500; color: var(--dark);">
                            Icon Class (Font Awesome)
                        </label>
                        <input type="text" class="form-control" 
                               placeholder="e.g. fa-laptop" 
                               id="iconInput"
                               style="border-radius: 8px; border: 1px solid var(--gray-300); padding: 12px 16px;" />
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Visit <a href="https://fontawesome.com/icons" target="_blank">Font Awesome</a> to browse icons
                </small>
            </div>

                    <!-- Icon Preview -->
                    <div id="iconPreview" class="text-center p-4" style="background: var(--light-gray); border-radius: 8px; display: none;">
                        <i class="fas fa-laptop" style="font-size: 48px; color: var(--primary);"></i>
                        <p class="text-muted mb-0 mt-2">Icon Preview</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Sticky Form Footer -->
<div class="form-footer">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center" style="color: var(--gray-600);">
                    <i class="fas fa-edit me-2"></i>
                    <span id="saveStatus">Creating new category</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="saveDraft">
                        <i class="fas fa-save me-1"></i>Save Draft
                    </button>
                    <a asp-action="Index" class="btn btn-outline-danger">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <button type="submit" form="categoryForm" class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-check me-1"></i>Create Category
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('categoryName');
            const seoLinkInput = document.getElementById('seoLinkInput');
            const generateSlugBtn = document.getElementById('generateSlug');
            const urlPreview = document.getElementById('urlPreview');
            const slugStatus = document.getElementById('slugStatus');
            const iconInput = document.getElementById('iconInput');
            const iconPreview = document.getElementById('iconPreview');
            const saveStatus = document.getElementById('saveStatus');
            
            // Auto-generate slug on name input
            nameInput.addEventListener('input', function() {
                if (seoLinkInput.value === '' || seoLinkInput.dataset.autoGenerated === 'true') {
                    generateSlug();
                    seoLinkInput.dataset.autoGenerated = 'true';
                }
                updateSaveStatus();
            });
            
            // Manual slug input
            seoLinkInput.addEventListener('input', function() {
                seoLinkInput.dataset.autoGenerated = 'false';
                updateUrlPreview();
                validateSlug();
                updateSaveStatus();
            });
            
            // Generate slug button
            generateSlugBtn.addEventListener('click', function() {
                generateSlug();
                seoLinkInput.dataset.autoGenerated = 'true';
            });
            
            // Icon input
            iconInput.addEventListener('input', function() {
                const iconClass = this.value.trim();
                if (iconClass) {
                    iconPreview.style.display = 'block';
                    const iconElement = iconPreview.querySelector('i');
                    iconElement.className = 'fas ' + iconClass;
                } else {
                    iconPreview.style.display = 'none';
                }
            });
            
            function generateSlug() {
                const name = nameInput.value;
                if (name) {
                    const slug = name
                        .toLowerCase()
                        .replace(/ğ/g, 'g')
                        .replace(/ü/g, 'u')
                        .replace(/ş/g, 's')
                        .replace(/ı/g, 'i')
                        .replace(/ö/g, 'o')
                        .replace(/ç/g, 'c')
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    
                    seoLinkInput.value = slug;
                    updateUrlPreview();
                    validateSlug();
                }
            }
            
            function updateUrlPreview() {
                const slug = seoLinkInput.value || '';
                urlPreview.textContent = 'yoursite.com/category/' + (slug || '[slug]');
            }
            
            function validateSlug() {
                const slug = seoLinkInput.value;
                
                if (!slug) {
                    slugStatus.textContent = '';
                    seoLinkInput.classList.remove('is-valid', 'is-invalid');
                    return;
                }
                
                const isValid = /^[a-z0-9-]+$/.test(slug) && !slug.startsWith('-') && !slug.endsWith('-');
                
                if (isValid) {
                    seoLinkInput.classList.remove('is-invalid');
                    seoLinkInput.classList.add('is-valid');
                    slugStatus.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Valid URL';
                    
                    // Check uniqueness via AJAX
                    checkSlugUniqueness(slug);
                } else {
                    seoLinkInput.classList.remove('is-valid');
                    seoLinkInput.classList.add('is-invalid');
                    slugStatus.innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i>Invalid format';
                }
            }
            
            function checkSlugUniqueness(slug) {
                fetch('@Url.Action("CheckSlug", "Category")?seoLink=' + encodeURIComponent(slug))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            seoLinkInput.classList.remove('is-valid');
                            seoLinkInput.classList.add('is-invalid');
                            slugStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Already exists';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking slug:', error);
                    });
            }
            
            function updateSaveStatus() {
                const name = nameInput.value.trim();
                if (name) {
                    saveStatus.textContent = `Creating "${name}"`;
                } else {
                    saveStatus.textContent = 'Creating new category';
                }
            }
            
            // Save draft
            document.getElementById('saveDraft').addEventListener('click', function() {
                const formData = {
                    name: nameInput.value,
                    seoLink: seoLinkInput.value,
                    icon: iconInput.value,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('categoryDraft', JSON.stringify(formData));
                showToast('Draft saved successfully!', 'success');
            });
            
            // Load draft
            const savedDraft = localStorage.getItem('categoryDraft');
            if (savedDraft && !nameInput.value) {
                try {
                    const draft = JSON.parse(savedDraft);
                    const draftAge = new Date() - new Date(draft.timestamp);
                    
                    if (draftAge < 24 * 60 * 60 * 1000) {
                        if (confirm('You have a saved draft. Would you like to load it?')) {
                            nameInput.value = draft.name;
                            seoLinkInput.value = draft.seoLink;
                            iconInput.value = draft.icon;
                            updateUrlPreview();
                            validateSlug();
                            iconInput.dispatchEvent(new Event('input'));
                        }
                    } else {
                        localStorage.removeItem('categoryDraft');
                    }
                } catch (e) {
                    localStorage.removeItem('categoryDraft');
                }
            }
            
            // Clear draft on submit
            document.getElementById('categoryForm').addEventListener('submit', function() {
                localStorage.removeItem('categoryDraft');
            });
            
            // Initial update
            updateUrlPreview();
        });
    </script>
}
