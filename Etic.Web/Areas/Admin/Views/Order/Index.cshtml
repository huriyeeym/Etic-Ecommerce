@model IEnumerable<Etic.Entities.Orders>

@{
    ViewData["Title"] = "Order Management";
    ViewData["Breadcrumb"] = ViewData["Breadcrumb"];
}

<!-- Metrics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon primary">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="metric-value">@ViewBag.TotalOrders</div>
            <div class="metric-label">Total Orders</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value">@ViewBag.PendingOrders</div>
            <div class="metric-label">Pending</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon info">
                <i class="fas fa-truck"></i>
            </div>
            <div class="metric-value">@ViewBag.ShippedOrders</div>
            <div class="metric-label">Shipped</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-value">@ViewBag.DeliveredOrders</div>
            <div class="metric-label">Delivered</div>
        </div>
    </div>
</div>

<!-- Revenue & Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon success">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="metric-value">₺@ViewBag.TotalRevenue.ToString("N2")</div>
            <div class="metric-label">Total Revenue</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon info">
                <i class="fas fa-check"></i>
            </div>
            <div class="metric-value">@ViewBag.ConfirmedOrders</div>
            <div class="metric-label">Confirmed</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon danger">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="metric-value">@ViewBag.CancelledOrders</div>
            <div class="metric-label">Cancelled</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon warning">
                <i class="fas fa-undo"></i>
            </div>
            <div class="metric-value">@ViewBag.ReturnedOrders</div>
            <div class="metric-label">Returned</div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="data-table">
    <!-- Table Header with Filters -->
    <div class="table-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="table-filters">
                    <div class="filter-input">
                        <input type="text" id="searchInput" placeholder="Search Order ID, Customer" class="form-control">
                    </div>
                    <div class="filter-input" style="min-width: 150px;">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Status</option>
                            <option value="1">Pending</option>
                            <option value="2">Confirmed</option>
                            <option value="3">Shipped</option>
                            <option value="4">Delivered</option>
                            <option value="5">Cancelled</option>
                            <option value="6">Returned</option>
                        </select>
                    </div>
                    <div class="filter-input" style="min-width: 150px;">
                        <select id="paymentFilter" class="form-select">
                            <option value="">All Payment</option>
                            <option value="1">Cash on Delivery</option>
                            <option value="2">Credit Card</option>
                            <option value="3">Bank Transfer</option>
                            <option value="4">Iyzico</option>
                        </select>
                    </div>
                    <button class="btn btn-outline-primary" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Table -->
    @if (Model != null && Model.Any())
    {
        <table class="table" id="orderTable">
            <thead>
                <tr>
                    <th style="width: 100px;">Order ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Payment</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    var statusClass = order.Status switch
                    {
                        Etic.Entities.Enums.OrderStatus.Pending => "warning",
                        Etic.Entities.Enums.OrderStatus.Confirmed => "info",
                        Etic.Entities.Enums.OrderStatus.Shipped => "primary",
                        Etic.Entities.Enums.OrderStatus.Delivered => "success",
                        Etic.Entities.Enums.OrderStatus.Cancelled => "danger",
                        Etic.Entities.Enums.OrderStatus.Returned => "secondary",
                        _ => "secondary"
                    };

                    var statusText = order.Status switch
                    {
                        Etic.Entities.Enums.OrderStatus.Pending => "Pending",
                        Etic.Entities.Enums.OrderStatus.Confirmed => "Confirmed",
                        Etic.Entities.Enums.OrderStatus.Shipped => "Shipped",
                        Etic.Entities.Enums.OrderStatus.Delivered => "Delivered",
                        Etic.Entities.Enums.OrderStatus.Cancelled => "Cancelled",
                        Etic.Entities.Enums.OrderStatus.Returned => "Returned",
                        _ => "Unknown"
                    };

                    var paymentText = order.PaymentType switch
                    {
                        Etic.Entities.Enums.PaymentType.CashOnDelivery => "Cash on Delivery",
                        Etic.Entities.Enums.PaymentType.CreditCard => "Credit Card",
                        Etic.Entities.Enums.PaymentType.BankTransfer => "Bank Transfer",
                        Etic.Entities.Enums.PaymentType.Iyzico => "Iyzico",
                        _ => "N/A"
                    };

                    <tr data-id="@order.Id" 
                        data-status="@((int)order.Status)" 
                        data-payment="@((int?)order.PaymentType ?? 0)"
                        data-search="@order.Id @order.User?.FirstName @order.User?.LastName @order.User?.Email">
                        
                        <td>
                            <strong style="color: var(--primary);">#@order.Id</strong>
                        </td>
                        
                        <td>
                            <div class="d-flex align-items-center">
                                <!-- Avatar -->
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--info)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 12px;">
                                    @if (order.User != null)
                                    {
                                        var initials = $"{order.User.FirstName?.FirstOrDefault()}{order.User.LastName?.FirstOrDefault()}";
                                        @initials.ToUpper()
                                    }
                                    else
                                    {
                                        <text>?</text>
                                    }
                                </div>
                                <div>
                                    <div style="font-weight: 500; color: var(--dark);">
                                        @(order.User?.FirstName) @(order.User?.LastName)
                                    </div>
                                    <div style="font-size: 12px; color: var(--gray);">
                                        @(order.User?.Email)
                                    </div>
                                </div>
                            </div>
                        </td>
                        
                        <td>
                            <div style="color: var(--dark);">@order.CreateDate.ToString("dd MMM yyyy")</div>
                            <div style="font-size: 12px; color: var(--gray);">@order.CreateDate.ToString("HH:mm")</div>
                        </td>
                        
                        <td>
                            <span style="font-size: 13px; color: var(--gray);">@paymentText</span>
                        </td>
                        
                        <td>
                            <strong style="color: var(--dark);">₺@order.TotalAmount.ToString("N2")</strong>
                        </td>
                        
                        <td>
                            <select class="form-select form-select-sm status-select" 
                                    data-order-id="@order.Id" 
                                    onchange="changeStatus(this)"
                                    style="border-radius: 8px; padding: 4px 8px; font-size: 13px; border: 2px solid var(--@statusClass); color: var(--@statusClass); font-weight: 500;">
                                <option value="1" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Pending)">Pending</option>
                                <option value="2" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Confirmed)">Confirmed</option>
                                <option value="3" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Shipped)">Shipped</option>
                                <option value="4" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Delivered)">Delivered</option>
                                <option value="5" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Cancelled)">Cancelled</option>
                                <option value="6" selected="@(order.Status == Etic.Entities.Enums.OrderStatus.Returned)">Returned</option>
                            </select>
                        </td>
                        
                        <td>
                            <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-sm btn-outline-primary" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button onclick="deleteOrder(@order.Id)" class="btn btn-sm btn-outline-danger" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Table Footer -->
        <div class="table-footer">
            <div class="pagination-info">
                Showing <strong>@Model.Count()</strong> orders
            </div>
        </div>
    }
    else
    {
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <h5>No Orders Yet</h5>
            <p>Orders from customers will appear here</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Filtreleme
        function updateTable() {
            const searchValue = $('#searchInput').val().toLowerCase();
            const statusValue = $('#statusFilter').val();
            const paymentValue = $('#paymentFilter').val();

            $('#orderTable tbody tr').each(function() {
                const row = $(this);
                const searchText = row.data('search')?.toString().toLowerCase() || '';
                const status = row.data('status')?.toString() || '';
                const payment = row.data('payment')?.toString() || '';

                let show = true;

                // Search filter
                if (searchValue && !searchText.includes(searchValue)) {
                    show = false;
                }

                // Status filter
                if (statusValue && status !== statusValue) {
                    show = false;
                }

                // Payment filter
                if (paymentValue && payment !== paymentValue) {
                    show = false;
                }

                row.toggle(show);
            });

            updatePaginationInfo();
        }

        function clearFilters() {
            $('#searchInput').val('');
            $('#statusFilter').val('');
            $('#paymentFilter').val('');
            updateTable();
        }

        function updatePaginationInfo() {
            const visibleRows = $('#orderTable tbody tr:visible').length;
            $('.pagination-info').html(`Showing <strong>${visibleRows}</strong> orders`);
        }

        // Status değiştir (AJAX)
        function changeStatus(selectElement) {
            const orderId = $(selectElement).data('order-id');
            const newStatus = $(selectElement).val();
            const originalValue = selectElement.getAttribute('data-original-value') || selectElement.value;

            if (!confirm('Are you sure you want to change this order status?')) {
                selectElement.value = originalValue;
                return;
            }

            // Loading state
            $(selectElement).prop('disabled', true);

            $.ajax({
                url: '/Admin/Order/UpdateStatus',
                method: 'POST',
                data: {
                    orderId: orderId,
                    status: newStatus
                },
                success: function(result) {
                    if (result.success) {
                        showToast(result.message, 'success');
                        selectElement.setAttribute('data-original-value', newStatus);
                        
                        // Select rengini güncelle
                        const statusColors = {
                            '1': 'warning',
                            '2': 'info',
                            '3': 'primary',
                            '4': 'success',
                            '5': 'danger',
                            '6': 'secondary'
                        };
                        $(selectElement).css('border-color', `var(--${statusColors[newStatus]})`);
                        $(selectElement).css('color', `var(--${statusColors[newStatus]})`);
                    } else {
                        showToast(result.message, 'error');
                        selectElement.value = originalValue;
                    }
                },
                error: function() {
                    showToast('Failed to update order status!', 'error');
                    selectElement.value = originalValue;
                },
                complete: function() {
                    $(selectElement).prop('disabled', false);
                }
            });
        }

        // Sipariş sil
        function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) {
                return;
            }

            $.ajax({
                url: '/Admin/Order/Delete',
                method: 'POST',
                data: { id: orderId },
                success: function(result) {
                    if (result.success) {
                        showToast(result.message, 'success');
                        $(`tr[data-id="${orderId}"]`).fadeOut(300, function() {
                            $(this).remove();
                            updatePaginationInfo();
                        });
                    } else {
                        showToast(result.message, 'error');
                    }
                },
                error: function() {
                    showToast('Failed to delete order!', 'error');
                }
            });
        }

        // Excel export (placeholder)
        function exportToExcel() {
            showToast('Excel export feature coming soon!', 'info');
        }

        // Event listeners
        $(document).ready(function() {
            $('#searchInput').on('keyup', updateTable);
            $('#statusFilter, #paymentFilter').on('change', updateTable);

            // Store original values for selects
            $('.status-select').each(function() {
                this.setAttribute('data-original-value', this.value);
            });
        });
    </script>
}

